(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.PrototypoCanvas=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){if(!Object.assign){Object.defineProperty(Object,"assign",{enumerable:false,configurable:true,writable:true,value:function(target){if(target===undefined||target===null){throw new TypeError("Cannot convert first argument to object")}var to=Object(target);for(var i=1;i<arguments.length;i++){var nextSource=arguments[i];if(nextSource===undefined||nextSource===null){continue}nextSource=Object(nextSource);var keysArray=Object.keys(Object(nextSource)),len=keysArray.length,nextIndex;for(nextIndex=0;nextIndex<len;nextIndex++){var nextKey=keysArray[nextIndex];var desc=Object.getOwnPropertyDescriptor(nextSource,nextKey);if(desc!==undefined&&desc.enumerable){to[nextKey]=nextSource[nextKey]}}}return to}})}module.exports=Object.assign},{}],2:[function(require,module,exports){var SelectionState={HANDLE_IN:1,HANDLE_OUT:2,POINT:4,SEGMENT:7},worldCoords=new Float32Array(6),viewCoords=new Float32Array(6);function drawHandles(ctx,segments,matrix,settings,zoom){var size=settings.handleSize,half=size/2,pX,pY;function drawHandle(j){var hX=Math.round(viewCoords[j]),hY=Math.round(viewCoords[j+1]),text;if(viewCoords[0]!==viewCoords[j]||viewCoords[1]!==viewCoords[j+1]){ctx.beginPath();ctx.strokeStyle=settings.handleColor;ctx.fillStyle=settings.handleColor;ctx.moveTo(pX,pY);ctx.lineTo(hX,hY);ctx.stroke();ctx.beginPath();ctx.arc(hX,hY,half,0,Math.PI*2,true);ctx.fill();if(settings.drawCoords){text=Math.round(worldCoords[j])+","+Math.round(worldCoords[j+1]);if(zoom<1.7){ctx.globalAlpha=.2}else if(zoom<3){ctx.globalAlpha=.4}ctx.fillText(text,hX-half-3-ctx.measureText(text).width,hY-2);if(zoom<3){ctx.globalAlpha=1}}}}for(var i=0,l=segments.length;i<l;i++){var segment=segments[i];segment._transformCoordinates(null,worldCoords,false);segment._transformCoordinates(matrix,viewCoords,false);var state=segment._selectionState;pX=Math.round(viewCoords[0]);pY=Math.round(viewCoords[1]);if(state&SelectionState.HANDLE_IN){drawHandle(2)}if(state&SelectionState.HANDLE_OUT){drawHandle(4)}ctx.fillStyle=settings.nodeColor;ctx.fillRect(pX-half,pY-half,size,size);ctx.font=settings.handleFont;if(settings.drawCoords){if(zoom<1.7){ctx.globalAlpha=.4}ctx.fillText(Math.round(worldCoords[0])+","+Math.round(worldCoords[1]),pX+half+5,pY-2);if(zoom<1.7){ctx.globalAlpha=1}}}}function _drawSelected(ctx,matrix){ctx.beginPath();ctx.stroke();drawHandles(ctx,this._segments,matrix,this._project._scope.settings,this._project._view._zoom)}module.exports={_drawSelected:_drawSelected}},{}],3:[function(require,module,exports){var shell=require("./worker"),assign=require("./assignPolyfill");var _={assign:assign},URL=window.URL||window.webkitURL;function load(opts){var PrototypoCanvas=this;opts=_.assign({fontUrl:"font.json",prototypoUrl:"prototypo.js"},opts);return Promise.all([!opts.fontSource&&opts.fontUrl,!opts.prototypoSource&&opts.prototypoUrl].map(function(url){return url&&fetch(url)})).then(function(results){return Promise.all([results[0]&&results[0].text(),results[1]&&results[1].text()])}).then(function(results){if(results[0]){opts.fontSource=results[0]}if(results[1]){opts.prototypoSource=results[1]}opts.fontObj=JSON.parse(opts.fontSource);if(opts.workerUrl){opts.workerUrl+="?bundleurl="+encodeURIComponent(opts.prototypoUrl)}else{opts.workerUrl=URL.createObjectURL(new Blob([opts.prototypoSource+";\n\n"+"("+shell.toString()+")();"+"//",{type:"text/javascript"}]))}return new Promise(function(resolve){var worker=new Worker(opts.workerUrl);worker.onmessage=function(e){if(e.data.type==="ready"){worker.postMessage({type:"font",data:opts.fontSource})}else if(e.data.type==="solvingOrders"){opts.worker=worker;Object.keys(e.data.data).forEach(function(key){if(e.data.data[key]){opts.fontObj.glyphs[key].solvingOrder=e.data.data[key]}});resolve()}}})}).then(function(){return new PrototypoCanvas(opts)})}module.exports=load},{"./assignPolyfill":1,"./worker":5}],4:[function(require,module,exports){var prototypo=typeof window!=="undefined"?window.prototypo:typeof global!=="undefined"?global.prototypo:null,assign=require("./assignPolyfill"),_drawSelected=require("./drawNodes")._drawSelected,load=require("./load");var _={assign:assign},paper=prototypo.paper;function fontBufferHandler(e){if(!(e.data instanceof ArrayBuffer)){this.isWorkerBusy=false;return}this.latestBuffer=e.data;this.font.addToFonts(e.data);if(this.latestValues){this.worker.postMessage({type:"update",data:this.latestValues});delete this.latestValues}else if(this.latestSubset){this.worker.postMessage({type:"subset",data:this.latestSubset});delete this.latestSubset}else{this.isWorkerBusy=false}}function PrototypoCanvas(opts){paper.setup(opts.canvas);opts.canvas.setAttribute("touch-action","none");this.opts=_.assign({fill:true,shoNodes:false,zoomFactor:.05,jQueryListeners:true},opts);this.canvas=opts.canvas;this.view=paper.view;this.view.center=[0,0];this.project=paper.project;this.project.activeLayer.applyMatrix=false;this.project.activeLayer.scale(1,-1);this.worker=opts.worker;this._fill=this.opts.fill;this._showNodes=this.opts.showNodes;this.font=prototypo.parametricFont(opts.fontObj);this.isMousedown=false;this.worker.onmessage=fontBufferHandler.bind(this);if("jQuery"in window&&this.opts.jQueryListeners){var $=window.jQuery,type="PointerEventsPolyfill"in window||"PointerEvent"in window?"pointer":"mouse";$(opts.canvas).on("wheel",this.wheelHandler.bind(this));$(opts.canvas).on(type+"move",this.moveHandler.bind(this));$(opts.canvas).on(type+"down",this.downHandler.bind(this));$(document).on(type+"up",this.upHandler.bind(this))}var raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame,updateLoop=function(){raf(updateLoop);if(!this.latestRafValues||!this.currGlyph){return}this.currGlyph.update(this.latestRafValues);this.view.update();delete this.latestRafValues}.bind(this);updateLoop()}Object.defineProperties(PrototypoCanvas.prototype,{zoom:{get:function(){return this.view.zoom},set:function(zoom){this.view.zoom=zoom}},fill:{get:function(){return this._fill},set:function(bool){this._fill=bool;this.displayGlyph()}},showNodes:{get:function(){return this._showNodes},set:function(bool){this._showNodes=bool;this.displayGlyph()}},showCoords:{get:function(){return paper.settings.drawCoords},set:function(bool){paper.settings.drawCoords=bool;this.displayGlyph()}}});PrototypoCanvas.prototype.wheelHandler=function(event){var bcr=this.canvas.getBoundingClientRect(),currPos=new paper.Point(event.clientX-bcr.left,event.clientY-bcr.top),viewPos=this.view.viewToProject(currPos),factor=1+this.opts.zoomFactor*Math.abs(event.deltaY/event.deltaMode?3:40)/20,newZoom=event.deltaY<0?this.view.zoom*factor:event.deltaY>0?this.view.zoom/factor:this.view.zoom,beta=this.view.zoom/newZoom,difference=viewPos.subtract(this.view.center),newCenter=viewPos.subtract(difference.multiply(beta));this.zoom=newZoom;this.view.center=newCenter;event.preventDefault()};PrototypoCanvas.prototype.moveHandler=function(event){if(!this.isMousedown){return}var currPos=new paper.Point(event.clientX,event.clientY),delta=currPos.subtract(this.prevPos);this.prevPos=currPos;this.view.center=this.view.center.subtract(delta.divide(this.view.zoom))};PrototypoCanvas.prototype.downHandler=function(event){if(event.button&&event.button!==0){return}this.isMousedown=true;this.prevPos=new paper.Point(event.clientX,event.clientY)};PrototypoCanvas.prototype.upHandler=function(){this.isMousedown=false};PrototypoCanvas.prototype.zoomIn=function(){this.zoom=this.view.zoom*1+this.opts.zoomFactor};PrototypoCanvas.prototype.zoomOut=function(){this.zoom=this.view.zoom/1+this.opts.zoomFactor};PrototypoCanvas.prototype.displayGlyph=function(_glyph){var glyph=_glyph===undefined?this.currGlyph:typeof _glyph==="string"?this.font.glyphMap[_glyph]:_glyph;if(glyph===undefined){return}if(this.currGlyph&&this.currGlyph!==glyph){this.currGlyph.visible=false;this.currGlyph.components.forEach(function(component){component.visible=false},this)}this.currGlyph=glyph;if(_glyph&&this.currValues){this.currGlyph.update(this.currValues)}this.currGlyph.visible=true;if(this._fill){this.currGlyph.fillColor="black";this.currGlyph.strokeWidth=0}else{this.currGlyph.fillColor=null;this.currGlyph.strokeColor="black";this.currGlyph.strokeWidth=1}this.currGlyph.contours.forEach(function(contour){contour.fullySelected=this._showNodes&&!contour.skeleton},this);this.currGlyph.components.forEach(function(component){component.visible=true;component.contours.forEach(function(contour){contour.fullySelected=this._showNodes&&!contour.skeleton},this)},this);this.view._project._needsUpdate=true;this.view.update()};PrototypoCanvas.prototype.displayChar=function(code){this.displayGlyph(typeof code==="string"?this.font.charMap[code.charCodeAt(0)]:code)};PrototypoCanvas.prototype.update=function(values){this.latestRafValues=values;if(!this.isWorkerBusy){this.isWorkerBusy=true;this.worker.postMessage({type:"update",data:values})}else{this.latestWorkerValues=values}this.currValues=values};PrototypoCanvas.prototype.subset=function(string){if(!this.isWorkerBusy){if(this.currSubset!==undefined){this.isWorkerBusy=true}this.worker.postMessage({type:"subset",data:string})}else{this.latestSubset=string}this.currSubset=string};PrototypoCanvas.prototype.download=function(){if(!this.latestBuffer){return}this.font.download(this.latestBuffer)};PrototypoCanvas.load=load;paper.PaperScope.prototype.Path.prototype._drawSelected=_drawSelected;_.assign(paper.settings,{handleSize:6,handleColor:"#FF725E",nodeColor:"#00C4D6",drawCoords:false,handleFont:"12px monospace"});module.exports=PrototypoCanvas},{"./assignPolyfill":1,"./drawNodes":2,"./load":3}],5:[function(require,module,exports){if("importScripts"in self){self.importScripts(decodeURIComponent(self.location.search.replace(/(\?|&)bundleurl=(.*?)(&|$)/,"$2")))}function worker(){var font,handlers={},currValues;self.postMessage({type:"ready"});prototypo.paper.setup({width:1024,height:1024});prototypo.paper.Font.prototype.addToFonts=function(){var buffer=this.ot.toBuffer();self.postMessage(buffer,[buffer])};self.onmessage=function(e){handlers[e.data.type](e.data.data)};handlers.font=function(fontSource){font=prototypo.parametricFont(JSON.parse(fontSource));var solvingOrders={};Object.keys(font.glyphMap).forEach(function(key){solvingOrders[key]=font.glyphMap[key].solvingOrder});self.postMessage({type:"solvingOrders",data:solvingOrders})};handlers.update=function(params){currValues=params;font.update(params);font.updateOTCommands().addToFonts()};handlers.subset=function(string){var prevSubset=font.subset||Object.keys(font.charMap);font.subset=string;var currSubset=font.subset||Object.keys(font.charMap);currSubset.filter(function(code){return prevSubset.indexOf(code)===-1}).forEach(function(code){if(font.charMap[code]){font.charMap[code].update(currValues);font.updateOTCommands()}});font.addToFonts()}}if("importScripts"in self){worker()}else{module.exports=worker}},{}]},{},[4])(4)});
//# sourceMappingURL=dist/prototypo-canvas.min.js.map