(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.PrototypoCanvas=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var baseAssign=require("lodash._baseassign"),createAssigner=require("lodash._createassigner"),keys=require("lodash.keys");function assignWith(object,source,customizer){var index=-1,props=keys(source),length=props.length;while(++index<length){var key=props[index],value=object[key],result=customizer(value,source[key],key,object,source);if((result===result?result!==value:value===value)||value===undefined&&!(key in object)){object[key]=result}}return object}var assign=createAssigner(function(object,source,customizer){return customizer?assignWith(object,source,customizer):baseAssign(object,source)});module.exports=assign},{"lodash._baseassign":2,"lodash._createassigner":4,"lodash.keys":8}],2:[function(require,module,exports){var baseCopy=require("lodash._basecopy"),keys=require("lodash.keys");function baseAssign(object,source){return source==null?object:baseCopy(source,keys(source),object)}module.exports=baseAssign},{"lodash._basecopy":3,"lodash.keys":8}],3:[function(require,module,exports){function baseCopy(source,props,object){object||(object={});var index=-1,length=props.length;while(++index<length){var key=props[index];object[key]=source[key]}return object}module.exports=baseCopy},{}],4:[function(require,module,exports){var bindCallback=require("lodash._bindcallback"),isIterateeCall=require("lodash._isiterateecall"),restParam=require("lodash.restparam");function createAssigner(assigner){return restParam(function(object,sources){var index=-1,length=object==null?0:sources.length,customizer=length>2?sources[length-2]:undefined,guard=length>2?sources[2]:undefined,thisArg=length>1?sources[length-1]:undefined;if(typeof customizer=="function"){customizer=bindCallback(customizer,thisArg,5);length-=2}else{customizer=typeof thisArg=="function"?thisArg:undefined;length-=customizer?1:0}if(guard&&isIterateeCall(sources[0],sources[1],guard)){customizer=length<3?undefined:customizer;length=1}while(++index<length){var source=sources[index];if(source){assigner(object,source,customizer)}}return object})}module.exports=createAssigner},{"lodash._bindcallback":5,"lodash._isiterateecall":6,"lodash.restparam":7}],5:[function(require,module,exports){function bindCallback(func,thisArg,argCount){if(typeof func!="function"){return identity}if(thisArg===undefined){return func}switch(argCount){case 1:return function(value){return func.call(thisArg,value)};case 3:return function(value,index,collection){return func.call(thisArg,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(thisArg,accumulator,value,index,collection)};case 5:return function(value,other,key,object,source){return func.call(thisArg,value,other,key,object,source)}}return function(){return func.apply(thisArg,arguments)}}function identity(value){return value}module.exports=bindCallback},{}],6:[function(require,module,exports){var reIsUint=/^\d+$/;var MAX_SAFE_INTEGER=9007199254740991;function baseProperty(key){return function(object){return object==null?undefined:object[key]}}var getLength=baseProperty("length");function isArrayLike(value){return value!=null&&isLength(getLength(value))}function isIndex(value,length){value=typeof value=="number"||reIsUint.test(value)?+value:-1;length=length==null?MAX_SAFE_INTEGER:length;return value>-1&&value%1==0&&value<length}function isIterateeCall(value,index,object){if(!isObject(object)){return false}var type=typeof index;if(type=="number"?isArrayLike(object)&&isIndex(index,object.length):type=="string"&&index in object){var other=object[index];return value===value?value===other:other!==other}return false}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isObject(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}module.exports=isIterateeCall},{}],7:[function(require,module,exports){var FUNC_ERROR_TEXT="Expected a function";var nativeMax=Math.max;function restParam(func,start){if(typeof func!="function"){throw new TypeError(FUNC_ERROR_TEXT)}start=nativeMax(start===undefined?func.length-1:+start||0,0);return function(){var args=arguments,index=-1,length=nativeMax(args.length-start,0),rest=Array(length);while(++index<length){rest[index]=args[start+index]}switch(start){case 0:return func.call(this,rest);case 1:return func.call(this,args[0],rest);case 2:return func.call(this,args[0],args[1],rest)}var otherArgs=Array(start+1);index=-1;while(++index<start){otherArgs[index]=args[index]}otherArgs[start]=rest;return func.apply(this,otherArgs)}}module.exports=restParam},{}],8:[function(require,module,exports){var getNative=require("lodash._getnative"),isArguments=require("lodash.isarguments"),isArray=require("lodash.isarray");var reIsUint=/^\d+$/;var objectProto=Object.prototype;var hasOwnProperty=objectProto.hasOwnProperty;var nativeKeys=getNative(Object,"keys");var MAX_SAFE_INTEGER=9007199254740991;function baseProperty(key){return function(object){return object==null?undefined:object[key]}}var getLength=baseProperty("length");function isArrayLike(value){return value!=null&&isLength(getLength(value))}function isIndex(value,length){value=typeof value=="number"||reIsUint.test(value)?+value:-1;length=length==null?MAX_SAFE_INTEGER:length;return value>-1&&value%1==0&&value<length}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function shimKeys(object){var props=keysIn(object),propsLength=props.length,length=propsLength&&object.length;var allowIndexes=!!length&&isLength(length)&&(isArray(object)||isArguments(object));var index=-1,result=[];while(++index<propsLength){var key=props[index];if(allowIndexes&&isIndex(key,length)||hasOwnProperty.call(object,key)){result.push(key)}}return result}function isObject(value){var type=typeof value;return!!value&&(type=="object"||type=="function")}var keys=!nativeKeys?shimKeys:function(object){var Ctor=object==null?null:object.constructor;if(typeof Ctor=="function"&&Ctor.prototype===object||typeof object!="function"&&isArrayLike(object)){return shimKeys(object)}return isObject(object)?nativeKeys(object):[]};function keysIn(object){if(object==null){return[]}if(!isObject(object)){object=Object(object)}var length=object.length;length=length&&isLength(length)&&(isArray(object)||isArguments(object))&&length||0;var Ctor=object.constructor,index=-1,isProto=typeof Ctor=="function"&&Ctor.prototype===object,result=Array(length),skipIndexes=length>0;while(++index<length){result[index]=index+""}for(var key in object){if(!(skipIndexes&&isIndex(key,length))&&!(key=="constructor"&&(isProto||!hasOwnProperty.call(object,key)))){result.push(key)}}return result}module.exports=keys},{"lodash._getnative":9,"lodash.isarguments":10,"lodash.isarray":11}],9:[function(require,module,exports){var funcTag="[object Function]";var reRegExpChars=/[.*+?^${}()|[\]\/\\]/g,reHasRegExpChars=RegExp(reRegExpChars.source);var reIsHostCtor=/^\[object .+?Constructor\]$/;function baseToString(value){if(typeof value=="string"){return value}return value==null?"":value+""}function isObjectLike(value){return!!value&&typeof value=="object"}var objectProto=Object.prototype;var fnToString=Function.prototype.toString;var hasOwnProperty=objectProto.hasOwnProperty;var objToString=objectProto.toString;var reIsNative=RegExp("^"+escapeRegExp(fnToString.call(hasOwnProperty)).replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function getNative(object,key){var value=object==null?undefined:object[key];return isNative(value)?value:undefined}function isNative(value){if(value==null){return false}if(objToString.call(value)==funcTag){return reIsNative.test(fnToString.call(value))}return isObjectLike(value)&&reIsHostCtor.test(value)}function escapeRegExp(string){string=baseToString(string);return string&&reHasRegExpChars.test(string)?string.replace(reRegExpChars,"\\$&"):string}module.exports=getNative},{}],10:[function(require,module,exports){var argsTag="[object Arguments]";function isObjectLike(value){return!!value&&typeof value=="object"}var objectProto=Object.prototype;var objToString=objectProto.toString;var MAX_SAFE_INTEGER=9007199254740991;function baseProperty(key){return function(object){return object==null?undefined:object[key]}}var getLength=baseProperty("length");function isArrayLike(value){return value!=null&&isLength(getLength(value))}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}function isArguments(value){return isObjectLike(value)&&isArrayLike(value)&&objToString.call(value)==argsTag}module.exports=isArguments},{}],11:[function(require,module,exports){var arrayTag="[object Array]",funcTag="[object Function]";var reRegExpChars=/[.*+?^${}()|[\]\/\\]/g,reHasRegExpChars=RegExp(reRegExpChars.source);var reIsHostCtor=/^\[object .+?Constructor\]$/;function baseToString(value){if(typeof value=="string"){return value}return value==null?"":value+""}function isObjectLike(value){return!!value&&typeof value=="object"}var objectProto=Object.prototype;var fnToString=Function.prototype.toString;var hasOwnProperty=objectProto.hasOwnProperty;var objToString=objectProto.toString;var reIsNative=RegExp("^"+escapeRegExp(fnToString.call(hasOwnProperty)).replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var nativeIsArray=getNative(Array,"isArray");var MAX_SAFE_INTEGER=9007199254740991;function getNative(object,key){var value=object==null?undefined:object[key];return isNative(value)?value:undefined}function isLength(value){return typeof value=="number"&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}var isArray=nativeIsArray||function(value){return isObjectLike(value)&&isLength(value.length)&&objToString.call(value)==arrayTag};function isNative(value){if(value==null){return false}if(objToString.call(value)==funcTag){return reIsNative.test(fnToString.call(value))}return isObjectLike(value)&&reIsHostCtor.test(value)}function escapeRegExp(string){string=baseToString(string);return string&&reHasRegExpChars.test(string)?string.replace(reRegExpChars,"\\$&"):string}module.exports=isArray},{}],12:[function(require,module,exports){(function(){"use strict";if(self.fetch){return}function normalizeName(name){if(typeof name!=="string"){name=name.toString()}if(/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(name)){throw new TypeError("Invalid character in header field name")}return name.toLowerCase()}function normalizeValue(value){if(typeof value!=="string"){value=value.toString()}return value}function Headers(headers){this.map={};if(headers instanceof Headers){headers.forEach(function(value,name){this.append(name,value)},this)}else if(headers){Object.getOwnPropertyNames(headers).forEach(function(name){this.append(name,headers[name])},this)}}Headers.prototype.append=function(name,value){name=normalizeName(name);value=normalizeValue(value);var list=this.map[name];if(!list){list=[];this.map[name]=list}list.push(value)};Headers.prototype["delete"]=function(name){delete this.map[normalizeName(name)]};Headers.prototype.get=function(name){var values=this.map[normalizeName(name)];return values?values[0]:null};Headers.prototype.getAll=function(name){return this.map[normalizeName(name)]||[]};Headers.prototype.has=function(name){return this.map.hasOwnProperty(normalizeName(name))};Headers.prototype.set=function(name,value){this.map[normalizeName(name)]=[normalizeValue(value)]};Headers.prototype.forEach=function(callback,thisArg){Object.getOwnPropertyNames(this.map).forEach(function(name){this.map[name].forEach(function(value){callback.call(thisArg,value,name,this)},this)},this)};function consumed(body){if(body.bodyUsed){return Promise.reject(new TypeError("Already read"))}body.bodyUsed=true}function fileReaderReady(reader){return new Promise(function(resolve,reject){reader.onload=function(){resolve(reader.result)};reader.onerror=function(){reject(reader.error)}})}function readBlobAsArrayBuffer(blob){var reader=new FileReader;reader.readAsArrayBuffer(blob);return fileReaderReady(reader)}function readBlobAsText(blob){var reader=new FileReader;reader.readAsText(blob);return fileReaderReady(reader)}var support={blob:"FileReader"in self&&"Blob"in self&&function(){try{new Blob;return true}catch(e){return false}}(),formData:"FormData"in self};function Body(){this.bodyUsed=false;this._initBody=function(body){this._bodyInit=body;if(typeof body==="string"){this._bodyText=body}else if(support.blob&&Blob.prototype.isPrototypeOf(body)){this._bodyBlob=body}else if(support.formData&&FormData.prototype.isPrototypeOf(body)){this._bodyFormData=body}else if(!body){this._bodyText=""}else{throw new Error("unsupported BodyInit type")}};if(support.blob){this.blob=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return Promise.resolve(this._bodyBlob)}else if(this._bodyFormData){throw new Error("could not read FormData body as blob")}else{return Promise.resolve(new Blob([this._bodyText]))}};this.arrayBuffer=function(){return this.blob().then(readBlobAsArrayBuffer)};this.text=function(){var rejected=consumed(this);if(rejected){return rejected}if(this._bodyBlob){return readBlobAsText(this._bodyBlob)}else if(this._bodyFormData){throw new Error("could not read FormData body as text")}else{return Promise.resolve(this._bodyText)}}}else{this.text=function(){var rejected=consumed(this);return rejected?rejected:Promise.resolve(this._bodyText)}}if(support.formData){this.formData=function(){return this.text().then(decode)}}this.json=function(){return this.text().then(JSON.parse)};return this}var methods=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function normalizeMethod(method){var upcased=method.toUpperCase();return methods.indexOf(upcased)>-1?upcased:method}function Request(url,options){options=options||{};this.url=url;this.credentials=options.credentials||"omit";this.headers=new Headers(options.headers);this.method=normalizeMethod(options.method||"GET");this.mode=options.mode||null;this.referrer=null;if((this.method==="GET"||this.method==="HEAD")&&options.body){throw new TypeError("Body not allowed for GET or HEAD requests")}this._initBody(options.body)}function decode(body){var form=new FormData;body.trim().split("&").forEach(function(bytes){if(bytes){var split=bytes.split("=");var name=split.shift().replace(/\+/g," ");var value=split.join("=").replace(/\+/g," ");form.append(decodeURIComponent(name),decodeURIComponent(value))}});return form}function headers(xhr){var head=new Headers;var pairs=xhr.getAllResponseHeaders().trim().split("\n");pairs.forEach(function(header){var split=header.trim().split(":");var key=split.shift().trim();var value=split.join(":").trim();head.append(key,value)});return head}Body.call(Request.prototype);function Response(bodyInit,options){if(!options){options={}}this._initBody(bodyInit);this.type="default";this.url=null;this.status=options.status;this.ok=this.status>=200&&this.status<300;this.statusText=options.statusText;this.headers=options.headers instanceof Headers?options.headers:new Headers(options.headers);this.url=options.url||""}Body.call(Response.prototype);self.Headers=Headers;self.Request=Request;self.Response=Response;self.fetch=function(input,init){var request;if(Request.prototype.isPrototypeOf(input)&&!init){request=input}else{request=new Request(input,init)}return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;function responseURL(){if("responseURL"in xhr){return xhr.responseURL}if(/^X-Request-URL:/m.test(xhr.getAllResponseHeaders())){return xhr.getResponseHeader("X-Request-URL")}return}xhr.onload=function(){var status=xhr.status===1223?204:xhr.status;if(status<100||status>599){reject(new TypeError("Network request failed"));return}var options={status:status,statusText:xhr.statusText,headers:headers(xhr),url:responseURL()};var body="response"in xhr?xhr.response:xhr.responseText;resolve(new Response(body,options))};xhr.onerror=function(){reject(new TypeError("Network request failed"))};xhr.open(request.method,request.url,true);if(request.credentials==="include"){xhr.withCredentials=true}if("responseType"in xhr&&support.blob){xhr.responseType="blob"}request.headers.forEach(function(value,name){xhr.setRequestHeader(name,value)});xhr.send(typeof request._bodyInit==="undefined"?null:request._bodyInit)})};self.fetch.polyfill=true})()},{}],13:[function(require,module,exports){var prototypo=typeof window!=="undefined"?window.prototypo:typeof global!=="undefined"?global.prototypo:null,assign=require("lodash.assign"),fetch=require("whatwg-fetch"),shell=require("./worker");var _={assign:assign},paper=prototypo.paper,URL=window.URL||window.webkitURL,workerSource;function PrototypoCanvas(opts){paper.setup(opts.canvas);opts.canvas.setAttribute("touch-action","none");this.opts=_.assign({zoomFactor:.05,jQueryListeners:true},opts);this.canvas=opts.canvas;this.view=paper.view;this.view.center=[0,0];this.project=paper.project;this.project.activeLayer.applyMatrix=false;this.project.activeLayer.scale(1,-1);this.worker=opts.worker;this.font=prototypo.parametricFont(opts.fontSource);this.isMousedown=false;this.worker.onmessage=function(e){this.latestBuffer=e.data;this.font.addToFonts(e.data);if(this.latestValues){this.worker.postMessage({type:"update",data:this.latestValues});delete this.latestValues}else{this.isWorkerBusy=false}}.bind(this);if("jQuery"in window&&this.opts.jQueryListeners){var $=window.jQuery,type="PointerEventsPolyfill"in window||"PointerEvent"in window?"pointer":"mouse";$(opts.canvas).on("wheel",this.wheelHandler.bind(this));$(opts.canvas).on(type+"move",this.moveHandler.bind(this));$(opts.canvas).on(type+"down",this.downHandler.bind(this));$(opts.canvas).on(type+"up",this.upHandler.bind(this))}}PrototypoCanvas.prototype.wheelHandler=function(event){var bcr=this.canvas.getBoundingClientRect(),currPos=new paper.Point(event.clientX-bcr.left,event.clientY-bcr.top),viewPos=this.view.viewToProject(currPos),factor=1+this.opts.zoomFactor*(Math.abs(event.deltaY)/3),newZoom=event.deltaY<0?this.view.zoom*factor:event.deltaY>0?this.view.zoom/factor:this.view.zoom,beta=this.view.zoom/newZoom,difference=viewPos.subtract(this.view.center),newCenter=viewPos.subtract(difference.multiply(beta));this.view.zoom=newZoom;this.view.center=newCenter;event.preventDefault()};PrototypoCanvas.prototype.moveHandler=function(event){if(!this.isMousedown){return}var currPos=new paper.Point(event.clientX,event.clientY),delta=currPos.subtract(this.prevPos);this.prevPos=currPos;this.view.center=this.view.center.subtract(delta.divide(this.view.zoom))};PrototypoCanvas.prototype.downHandler=function(event){this.isMousedown=true;this.prevPos=new paper.Point(event.clientX,event.clientY)};PrototypoCanvas.prototype.upHandler=function(){this.isMousedown=false};PrototypoCanvas.prototype.zoomIn=function(){this.view.zoom*=1+this.opts.zoomFactor};PrototypoCanvas.prototype.zoomOut=function(){this.view.zoom/=1+this.opts.zoomFactor};PrototypoCanvas.prototype.zoom=function(zoom){this.view.zoom=zoom};PrototypoCanvas.prototype.displayGlyph=function(name){if(this.currGlyph===this.font.glyphMap[name]){return}if(this.currGlyph){this.currGlyph.visible=false;this.currGlyph.components.forEach(function(component){component.visible=false})}this.currGlyph=this.font.glyphMap[name];if(this.currValues){this.currGlyph.update(this.currValues)}this.currGlyph.visible=true;this.currGlyph.contours.forEach(function(contour){contour.visible=!contour.skeleton});this.currGlyph.components.forEach(function(component){component.visible=true;component.contours.forEach(function(contour){contour.visible=!contour.skeleton})});this.view.update()};PrototypoCanvas.prototype.update=function(values){this.currValues=values;if(this.currGlyph){this.currGlyph.update(values);this.view.update()}if(!this.isWorkerBusy){this.isWorkerBusy=true;this.worker.postMessage({type:"update",data:values})}else{this.latestValues=values}};PrototypoCanvas.prototype.download=function(){if(!this.latestBuffer){return}this.font.download(this.latestBuffer)};PrototypoCanvas.load=function(opts){opts=_.assign({fontUrl:"font.json",prototypoUrl:"prototypo.js"},opts);return Promise.all([!opts.fontSource&&opts.fontUrl,!workerSource&&opts.prototypoUrl].map(function(url){return url&&fetch(url)})).then(function(results){return Promise.all([results[0]&&results[0].text(),results[1]&&results[1].text()])}).then(function(results){if(results[0]){opts.fontSource=JSON.parse(results[0])}if(results[1]){opts.workerSource=workerSource="("+shell.toString().replace("'prototypo.js';",function(){return results[1]})+")();"+"//"}return new Promise(function(resolve){var worker=new Worker(URL.createObjectURL(new Blob([opts.workerSource,{type:"text/javascript"}])));worker.onmessage=function(e){if(e.data.type==="ready"){worker.postMessage({type:"font",data:results[0]})}else if(e.data.type==="solvingOrders"){opts.worker=worker;Object.keys(e.data.data).forEach(function(key){if(e.data.data[key]){opts.fontSource.glyphs[key].solvingOrder=e.data.data[key]}});resolve()}}})}).then(function(){return new PrototypoCanvas(opts)})};module.exports=PrototypoCanvas},{"./worker":14,"lodash.assign":1,"whatwg-fetch":12}],14:[function(require,module,exports){module.exports=function worker(){"prototypo.js";var font,handlers={};self.postMessage({type:"ready"});prototypo.paper.setup({width:1024,height:1024});prototypo.paper.Font.prototype.addToFonts=function(){var buffer=this.ot.toBuffer();self.postMessage(buffer,[buffer])};self.onmessage=function(e){handlers[e.data.type](e.data.data)};handlers.font=function(fontSource){font=prototypo.parametricFont(JSON.parse(fontSource));var solvingOrders={};Object.keys(font.glyphMap).forEach(function(key){solvingOrders[key]=font.glyphMap[key].solvingOrder});self.postMessage({type:"solvingOrders",data:solvingOrders})};handlers.update=function(params){font.update(params);font.updateOTCommands().addToFonts()}}},{}]},{},[13])(13)});
//# sourceMappingURL=dist/prototypo-canvas.min.js.map