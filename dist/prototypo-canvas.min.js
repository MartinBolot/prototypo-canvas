(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.PrototypoCanvas=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function assign(target,firstSource){if(target===undefined||target===null){throw new TypeError("Cannot convert first argument to object")}var to=Object(target);for(var i=1;i<arguments.length;i++){var nextSource=arguments[i];if(nextSource===undefined||nextSource===null){continue}var keysArray=Object.keys(Object(nextSource));for(var nextIndex=0,len=keysArray.length;nextIndex<len;nextIndex++){var nextKey=keysArray[nextIndex];var desc=Object.getOwnPropertyDescriptor(nextSource,nextKey);if(desc!==undefined&&desc.enumerable){to[nextKey]=nextSource[nextKey]}}}return to}function polyfill(){if(!Object.assign){Object.defineProperty(Object,"assign",{enumerable:false,configurable:true,writable:true,value:assign})}}module.exports={assign:assign,polyfill:polyfill}},{}],2:[function(require,module,exports){(function(){"use strict";function EventEmitter(){}var proto=EventEmitter.prototype;var exports=this;var originalGlobalValue=exports.EventEmitter;function indexOfListener(listeners,listener){var i=listeners.length;while(i--){if(listeners[i].listener===listener){return i}}return-1}function alias(name){return function aliasClosure(){return this[name].apply(this,arguments)}}proto.getListeners=function getListeners(evt){var events=this._getEvents();var response;var key;if(evt instanceof RegExp){response={};for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){response[key]=events[key]}}}else{response=events[evt]||(events[evt]=[])}return response};proto.flattenListeners=function flattenListeners(listeners){var flatListeners=[];var i;for(i=0;i<listeners.length;i+=1){flatListeners.push(listeners[i].listener)}return flatListeners};proto.getListenersAsObject=function getListenersAsObject(evt){var listeners=this.getListeners(evt);var response;if(listeners instanceof Array){response={};response[evt]=listeners}return response||listeners};proto.addListener=function addListener(evt,listener){var listeners=this.getListenersAsObject(evt);var listenerIsWrapped=typeof listener==="object";var key;for(key in listeners){if(listeners.hasOwnProperty(key)&&indexOfListener(listeners[key],listener)===-1){listeners[key].push(listenerIsWrapped?listener:{listener:listener,once:false})}}return this};proto.on=alias("addListener");proto.addOnceListener=function addOnceListener(evt,listener){return this.addListener(evt,{listener:listener,once:true})};proto.once=alias("addOnceListener");proto.defineEvent=function defineEvent(evt){this.getListeners(evt);return this};proto.defineEvents=function defineEvents(evts){for(var i=0;i<evts.length;i+=1){this.defineEvent(evts[i])}return this};proto.removeListener=function removeListener(evt,listener){var listeners=this.getListenersAsObject(evt);var index;var key;for(key in listeners){if(listeners.hasOwnProperty(key)){index=indexOfListener(listeners[key],listener);if(index!==-1){listeners[key].splice(index,1)}}}return this};proto.off=alias("removeListener");proto.addListeners=function addListeners(evt,listeners){return this.manipulateListeners(false,evt,listeners)};proto.removeListeners=function removeListeners(evt,listeners){return this.manipulateListeners(true,evt,listeners)};proto.manipulateListeners=function manipulateListeners(remove,evt,listeners){var i;var value;var single=remove?this.removeListener:this.addListener;var multiple=remove?this.removeListeners:this.addListeners;if(typeof evt==="object"&&!(evt instanceof RegExp)){for(i in evt){if(evt.hasOwnProperty(i)&&(value=evt[i])){if(typeof value==="function"){single.call(this,i,value)}else{multiple.call(this,i,value)}}}}else{i=listeners.length;while(i--){single.call(this,evt,listeners[i])}}return this};proto.removeEvent=function removeEvent(evt){var type=typeof evt;var events=this._getEvents();var key;if(type==="string"){delete events[evt]}else if(evt instanceof RegExp){for(key in events){if(events.hasOwnProperty(key)&&evt.test(key)){delete events[key]}}}else{delete this._events}return this};proto.removeAllListeners=alias("removeEvent");proto.emitEvent=function emitEvent(evt,args){var listenersMap=this.getListenersAsObject(evt);var listeners;var listener;var i;var key;var response;for(key in listenersMap){if(listenersMap.hasOwnProperty(key)){listeners=listenersMap[key].slice(0);i=listeners.length;while(i--){listener=listeners[i];if(listener.once===true){this.removeListener(evt,listener.listener)}response=listener.listener.apply(this,args||[]);if(response===this._getOnceReturnValue()){this.removeListener(evt,listener.listener)}}}}return this};proto.trigger=alias("emitEvent");proto.emit=function emit(evt){var args=Array.prototype.slice.call(arguments,1);return this.emitEvent(evt,args)};proto.setOnceReturnValue=function setOnceReturnValue(value){this._onceReturnValue=value;return this};proto._getOnceReturnValue=function _getOnceReturnValue(){if(this.hasOwnProperty("_onceReturnValue")){return this._onceReturnValue}else{return true}};proto._getEvents=function _getEvents(){return this._events||(this._events={})};EventEmitter.noConflict=function noConflict(){exports.EventEmitter=originalGlobalValue;return EventEmitter};if(typeof define==="function"&&define.amd){define(function(){return EventEmitter})}else if(typeof module==="object"&&module.exports){module.exports=EventEmitter}else{exports.EventEmitter=EventEmitter}}).call(this)},{}],3:[function(require,module,exports){var prototypo=typeof window!=="undefined"?window.prototypo:typeof global!=="undefined"?global.prototypo:null,assign=require("es6-object-assign").assign,EventEmitter=require("wolfy87-eventemitter"),glyph=require("./utils/glyph"),mouseHandlers=require("./utils/mouseHandlers"),init=require("./utils/init"),loadFont=require("./utils/loadFont");var _={assign:assign},paper=prototypo.paper;function PrototypoCanvas(opts){paper.setup(opts.canvas);paper.settings.hitTolerance=1;opts.canvas.setAttribute("touch-action","none");this.opts=_.assign({fill:true,shoNodes:false,zoomFactor:.05,jQueryListeners:true,glyphrUrl:"http://www.glyphrstudio.com/online/"},opts);this.canvas=opts.canvas;this.view=paper.view;this.view.center=[0,0];this.project=paper.project;this.project.activeLayer.applyMatrix=false;this.project.activeLayer.scale(1,-1);this.worker=opts.worker;this._queue=[];this._fill=this.opts.fill;this._showNodes=this.opts.showNodes;this.fontsMap={};this.isMousedown=false;this.exportingZip=false;if(this.worker){this.worker.addEventListener("message",function(e){if(!this.currentJob){return}if(this.currentJob.callback){this.currentJob.callback(e.data)}else if(e.data instanceof ArrayBuffer){try{this.font.addToFonts(e.data)}catch(error){this.emitEvent("fonterror",[error])}}this.currentJob=false;this.dequeue()}.bind(this))}if("jQuery"in window&&this.opts.jQueryListeners){var $=window.jQuery,type="PointerEventsPolyfill"in window||"PointerEvent"in window?"pointer":"mouse";$(opts.canvas).on("wheel",this.onWheel.bind(this));$(opts.canvas).on(type+"move",this.onMove.bind(this));$(opts.canvas).on(type+"down",this.onDown.bind(this));$(document).on(type+"up",this.onUp.bind(this))}var raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame,updateLoop=function(){raf(updateLoop);if(!this.latestRafValues||!this.currGlyph||this.exportingZip){return}this.font.update(this.latestRafValues,[this.currGlyph]);this.view.update();delete this.latestRafValues}.bind(this);updateLoop()}PrototypoCanvas.prototype=Object.create(EventEmitter.prototype);PrototypoCanvas.init=init;PrototypoCanvas.prototype.loadFont=loadFont;_.assign(PrototypoCanvas.prototype,mouseHandlers);Object.defineProperties(PrototypoCanvas.prototype,{zoom:{get:function(){return this.view.zoom},set:function(zoom){this.view.zoom=zoom}},fill:{get:function(){return this._fill},set:function(bool){this._fill=bool;this.displayGlyph()}},showNodes:{get:function(){return this._showNodes},set:function(bool){this._showNodes=bool;this.displayGlyph()}},showCoords:{get:function(){return paper.settings.drawCoords},set:function(bool){paper.settings.drawCoords=bool;this.displayGlyph()}},subset:{get:function(){return this.font.subset},set:function(set){this.enqueue({type:"subset",data:set});this.font.subset=set}}});PrototypoCanvas.prototype.displayGlyph=glyph.displayGlyph;PrototypoCanvas.prototype.displayChar=function(code){this.latestChar=code;this.displayGlyph(typeof code==="string"?this.font.charMap[code.charCodeAt(0)]:code)};paper.PaperScope.prototype.Path.prototype._drawSelected=glyph._drawSelected;_.assign(paper.settings,{handleSize:6,handleColor:"#FF725E",nodeColor:"#00C4D6",drawCoords:false,handleFont:"12px monospace"});PrototypoCanvas.priorities=["update","subset","svgFont","otfFont","alternate"];PrototypoCanvas.prototype.enqueue=function(message){this._queue[PrototypoCanvas.priorities.indexOf(message.type)]=message;this.dequeue()};PrototypoCanvas.prototype.dequeue=function(){if(this.currentJob||!this.worker){return}for(var i=this._queue.length;i--;){if(this._queue[i]){this.currentJob=this._queue[i];var cb=this.currentJob.callback;delete this.currentJob.callback;this.worker.postMessage(this.currentJob);this.currentJob.callback=cb;this._queue[i]=null;break}}};PrototypoCanvas.prototype.emptyQueue=function(){this._queue=[];this.currentJob=false};PrototypoCanvas.prototype.update=function(values){this.latestValues=this.latestRafValues=values;this.enqueue({type:"update",data:values})};PrototypoCanvas.prototype.setAlternateFor=function(unicode,glyphName){if(!glyphName){Object.keys(unicode).forEach(function(code){if(parseInt(code)===this.currGlyph.src.unicode){this.displayChar(this.font.glyphMap[unicode[code]])}this.font.setAlternateFor(code,unicode[code])}.bind(this));this.enqueue({type:"alternate",data:{altList:unicode}})}else{this.font.setAlternateFor(unicode,glyphName);this.displayChar(this.font.glyphMap[glyphName]);this.enqueue({type:"alternate",data:{unicode:unicode,glyphName:glyphName}})}this.update(this.latestValues)};PrototypoCanvas.prototype.download=function(cb,name,merged,values){this.generateOtf(function(data){this.font.download(data,merged,name);if(cb){cb()}}.bind(this),name,merged,values)};PrototypoCanvas.prototype.getBlob=function(cb,name,merged,values){return new Promise(function(resolve,reject){try{this.generateOtf(function(data){resolve({buffer:data,variant:name.style});if(cb){cb()}},name,merged,values)}catch(err){reject(err)}}.bind(this))};PrototypoCanvas.prototype.generateOtf=function(cb,name,merged,values){if(!this.worker||!this.latestValues&&!values){return false}this.enqueue({type:"otfFont",data:{family:name&&name.family,style:name&&name.style,merged:merged,values:values},callback:function(data){if(cb){cb(data)}}})};PrototypoCanvas.prototype.openInGlyphr=function(cb){if(!this.worker||!this.latestValues){return false}this.enqueue({type:"otfFont",callback:function(data){var handler=function(e){window.removeEventListener("message",handler);if(e.data!=="ready"){return}e.source.postMessage(data,e.origin,[data]);if(cb){cb()}};window.open(this.opts.glyphrUrl);window.addEventListener("message",handler)}.bind(this)})};module.exports=PrototypoCanvas},{"./utils/glyph":4,"./utils/init":5,"./utils/loadFont":6,"./utils/mouseHandlers":7,"es6-object-assign":1,"wolfy87-eventemitter":2}],4:[function(require,module,exports){function displayComponents(glyph,showNodes){glyph.components.forEach(function(component){component.visible=true;component.contours.forEach(function(contour){contour.fullySelected=showNodes&&!contour.skeleton});if(component.components.length){displayComponents(component,showNodes)}})}function displayGlyph(_glyph){var glyph=_glyph===undefined?this.currGlyph:typeof _glyph==="string"?this.font.glyphMap[_glyph]:_glyph;if(glyph===undefined){return}if(this.currGlyph&&this.currGlyph!==glyph){this.currGlyph.visible=false;this.currGlyph.components.forEach(function(component){component.visible=false},this)}this.currGlyph=glyph;if(_glyph&&this.latestValues){this.currGlyph.update(this.latestValues)}this.currGlyph.visible=true;if(this._fill){this.currGlyph.fillColor="#333333";this.currGlyph.strokeWidth=0}else{this.currGlyph.fillColor=null;this.currGlyph.strokeWidth=1}this.currGlyph.contours.forEach(function(contour){contour.fullySelected=this._showNodes&&!contour.skeleton},this);if(this.currGlyph.components.length){displayComponents(this.currGlyph,this._showNodes)}this.view._project._needsUpdate=true;this.view.update()}var SelectionState={HANDLE_IN:1,HANDLE_OUT:2,POINT:4,SEGMENT:7},worldCoords=new Float32Array(6),viewCoords=new Float32Array(6);function drawHandles(ctx,segments,matrix,settings,zoom){var size=settings.handleSize,half=size/2,pX,pY;function drawHandle(j){var hX=Math.round(viewCoords[j]),hY=Math.round(viewCoords[j+1]),text;if(viewCoords[0]!==viewCoords[j]||viewCoords[1]!==viewCoords[j+1]){ctx.beginPath();ctx.strokeStyle=settings.handleColor;ctx.fillStyle=settings.handleColor;ctx.moveTo(pX,pY);ctx.lineTo(hX,hY);ctx.stroke();ctx.beginPath();ctx.arc(hX,hY,half,0,Math.PI*2,true);ctx.fill();if(settings.drawCoords){text=Math.round(worldCoords[j])+","+Math.round(worldCoords[j+1]);if(zoom<1.7){ctx.globalAlpha=.2}else if(zoom<3){ctx.globalAlpha=.4}ctx.fillText(text,hX-half-3-ctx.measureText(text).width,hY-2);if(zoom<3){ctx.globalAlpha=1}}}}for(var i=0,l=segments.length;i<l;i++){var segment=segments[i];segment._transformCoordinates(null,worldCoords,false);segment._transformCoordinates(matrix,viewCoords,false);var state=segment._selectionState;pX=Math.round(viewCoords[0]);pY=Math.round(viewCoords[1]);if(state&SelectionState.HANDLE_IN){drawHandle(2)}if(state&SelectionState.HANDLE_OUT){drawHandle(4)}ctx.fillStyle=settings.nodeColor;ctx.fillRect(pX-half,pY-half,size,size);ctx.font=settings.handleFont;if(settings.drawCoords){if(zoom<1.7){ctx.globalAlpha=.4}ctx.fillText(Math.round(worldCoords[0])+","+Math.round(worldCoords[1]),pX+half+5,pY-2);if(zoom<1.7){ctx.globalAlpha=1}}}}function _drawSelected(ctx,matrix){ctx.beginPath();ctx.stroke();drawHandles(ctx,this._segments,matrix,this._project._scope.settings,this._project._view._zoom)}module.exports={displayGlyph:displayGlyph,_drawSelected:_drawSelected}},{}],5:[function(require,module,exports){var shell=require("./../worker");var URL=typeof window!=="undefined"&&(window.URL||window.webkitURL);module.exports=function init(opts){var constructor=this;if(!opts.workerUrl){opts.workerUrl=URL.createObjectURL(new Blob(["("+shell.toString()+")();"+"//",{type:"text/javascript"}]))}return new Promise(function(resolve){var worker=opts.worker=new Worker(opts.workerUrl),handler=function initWorker(){worker.removeEventListener("message",handler);resolve()};worker.addEventListener("message",handler);worker.postMessage(Array.isArray(opts.workerDeps)?opts.workerDeps:[opts.workerDeps])}).then(function(){return new constructor(opts)})}},{"./../worker":8}],6:[function(require,module,exports){function translateGlyph(self){if(!self.currGlyph){return}self.displayGlyph(self.font.glyphMap[self.currGlyph.name]||self.font.charMap[self.currGlyph.ot.unicode]||self.font.glyphMap[".undef"])}module.exports=function loadFont(name,fontSource){this.emptyQueue();this.latestValues=this.latestRafValues=null;if(name in this.fontsMap){this.font=this.fontsMap[name];translateGlyph(this);this.worker.postMessage({type:"font",name:name});return Promise.resolve(this.font)}return(fontSource.charAt(0)==="{"?Promise.resolve(fontSource):fetch(fontSource)).then(function(result){return typeof result==="string"||result.text()}).then(function(result){if(result!==true){fontSource=result}return new Promise(function(resolve){var fontObj=JSON.parse(fontSource),handler=function(e){if(typeof e.data!=="object"){return}this.worker.removeEventListener("message",handler);Object.keys(e.data).forEach(function(key){if(fontObj.glyphs[key]){fontObj.glyphs[key].solvingOrder=e.data[key]}});this.font=prototypo.parametricFont(fontObj);this.fontsMap[name]=this.font;translateGlyph(this);resolve(this)}.bind(this);this.worker.addEventListener("message",handler);this.worker.postMessage({type:"font",name:name,data:fontSource})}.bind(this))}.bind(this))}},{}],7:[function(require,module,exports){var paper=(typeof window!=="undefined"?window.prototypo:typeof global!=="undefined"?global.prototypo:null).paper;function wheelHandler(event){var bcr=this.canvas.getBoundingClientRect(),currPos=new paper.Point(event.clientX-bcr.left,event.clientY-bcr.top),viewPos=this.view.viewToProject(currPos),factor=1+this.opts.zoomFactor*Math.abs(event.deltaY/event.deltaMode?3:40*20),newZoom=event.deltaY<0?this.view.zoom*factor:event.deltaY>0?this.view.zoom/factor:this.view.zoom,beta=this.view.zoom/newZoom,difference=viewPos.subtract(this.view.center),newCenter=viewPos.subtract(difference.multiply(beta));this.zoom=newZoom;this.view.center=newCenter;event.preventDefault()}function moveHandler(event){if(!this.isMousedown){return}var currPos=new paper.Point(event.clientX,event.clientY),delta=currPos.subtract(this.prevPos);this.prevPos=currPos;this.view.center=this.view.center.subtract(delta.divide(this.view.zoom))}function downHandler(event){if(event.button&&event.button!==0){return}this.isMousedown=true;this.prevPos=new paper.Point(event.clientX,event.clientY)}function upHandler(){this.isMousedown=false}function zoomIn(){this.zoom=this.view.zoom*1+this.opts.zoomFactor}function zoomOut(){this.zoom=this.view.zoom/1+this.opts.zoomFactor}module.exports={onWheel:wheelHandler,onMove:moveHandler,onDown:downHandler,onUp:upHandler,zoomIn:zoomIn,zoomOut:zoomOut}},{}],8:[function(require,module,exports){function prepareWorker(){function runWorker(){var font,handlers={},fontsMap={},currValues,currSubset=[],translateSubset=function(){if(!currSubset.length){return}font.subset=currSubset.map(function(glyph){return font.charMap[glyph.ot.unicode]}).filter(Boolean);currSubset=font.subset};prototypo.paper.setup({width:1024,height:1024});self.onmessage=function(e){var result;if(e.data.type&&e.data.type in handlers){result=handlers[e.data.type](e.data.data,e.data.name);if(result===null){return}self.postMessage(result,result instanceof ArrayBuffer?[result]:undefined)}};handlers.font=function(fontSource,name){if(name in fontsMap){font=fontsMap[name];translateSubset();return null}var fontObj=JSON.parse(fontSource);font=prototypo.parametricFont(fontObj);fontsMap[name]=font;translateSubset();var solvingOrders={};Object.keys(font.glyphMap).forEach(function(key){solvingOrders[key]=font.glyphMap[key].solvingOrder});return solvingOrders};handlers.update=function(params){currValues=params;font.update(currValues);font.updateOTCommands();var result=font.toArrayBuffer();return result};handlers.soloAlternate=function(params){font.setAlternateFor(params.unicode,params.glyphName);if(!currValues){return true}font.subset=font.subset.map(function(glyph){return String.fromCharCode(glyph.unicode)}).join("");var altGlyph=font.glyphMap[params.glyphName];altGlyph.update(currValues);altGlyph.updateOTCommands();font.updateOT({set:undefined});return font.toArrayBuffer()};handlers.alternate=function(params){if(params.altList){Object.keys(params.altList).forEach(function(unicode){handlers.soloAlternate({unicode:unicode,glyphName:params.altList[unicode]})})}else{handlers.soloAlternate(params)}};handlers.subset=function(set){var prevGlyphs=currSubset.map(function(glyph){return glyph.name});font.subset=set;currSubset=font.subset;if(!currValues){return true}currSubset.filter(function(glyph){return prevGlyphs.indexOf(glyph.name)===-1}).forEach(function(glyph){glyph.update(currValues);glyph.updateOTCommands()});font.updateOT({set:undefined});return font.toArrayBuffer()};handlers.otfFont=function(data){var allChars=font.getGlyphSubset(false);var fontValues=data&&data.values||currValues;font.update(fontValues,allChars);font.updateOTCommands(allChars,data&&data.merged||false);var family=font.ot.familyName;var style=font.ot.styleName;font.ot.familyName=data&&data.family||"Prototypo";font.ot.styleName=data&&data.style||"regular";var result=font.toArrayBuffer();font.ot.familyName=family;font.ot.styleName=style;return result}}if(typeof global==="undefined"&&"importScripts"in self){var handler=function initWorker(e){self.removeEventListener("message",handler);self.importScripts(e.data);runWorker();self.postMessage("ready")};self.addEventListener("message",handler)}}if(typeof global==="undefined"&&"importScripts"in self){prepareWorker()}else{module.exports=prepareWorker}},{}]},{},[3])(3)});
//# sourceMappingURL=dist/prototypo-canvas.min.js.map